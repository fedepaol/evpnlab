#!/usr/sbin/nft -f

# Flush existing rules
flush ruleset

table ip nat {
    chain PREROUTING {
        type nat hook prerouting priority dstnat; policy accept;

        # Load balance traffic to VIP between two backend servers
        # Using stateful connection tracking with consistent hashing
        ip daddr 10.255.255.1 ct state new dnat to jhash ip saddr . tcp sport mod 2 map { \
            0 : 192.168.10.2, \
            1 : 192.168.11.2 \
        }

        # For established connections, use conntrack
        ip daddr 10.255.255.1 ct state established,related accept
    }

    chain POSTROUTING {
        type nat hook postrouting priority srcnat; policy accept;

        # Masquerade traffic going to backend servers
        ip daddr 192.168.10.2 masquerade
        ip daddr 192.168.11.2 masquerade
    }
}
