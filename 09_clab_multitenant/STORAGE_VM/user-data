#cloud-config
hostname: storage

# Set password for fedora user
chpasswd:
  list: |
    fedora:fedora
  expire: False

# Configure SSH
ssh_pwauth: True

runcmd:
  # Configure DNS via systemd-resolved
  - mkdir -p /etc/systemd/resolved.conf.d
  - |
    cat > /etc/systemd/resolved.conf.d/dns.conf <<'EOF'
    [Resolve]
    DNS=8.8.8.8 8.8.4.4
    FallbackDNS=1.1.1.1 1.0.0.1
    EOF
  - systemctl restart systemd-resolved

# Write setup script to the VM
write_files:
  - path: /home/fedora/setup-storage.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "=== Storage VM Setup Script ==="
      echo ""

      # Install FRR
      echo "=== Installing FRR ==="
      sudo dnf install -y frr

      # Enable IP forwarding
      echo "=== Enabling IP forwarding ==="
      sudo sysctl -w net.ipv4.ip_forward=1
      echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf

      # Configure loopback interface with IP to advertise
      echo "=== Configuring loopback interface ==="
      sudo ip addr add 10.200.0.1/32 dev lo 2>/dev/null || echo "Loopback IP already configured"
      # Add route so FRR network statement can find it
      sudo ip route add 10.200.0.1/32 dev lo 2>/dev/null || echo "Loopback route already configured"

      # Enable FRR daemons
      echo "=== Enabling BGP daemon ==="
      sudo sed -i 's/bgpd=no/bgpd=yes/' /etc/frr/daemons

      # Create FRR configuration
      echo "=== Creating FRR configuration ==="
      sudo tee /etc/frr/frr.conf > /dev/null <<'EOF'
      frr version 8.0
      frr defaults traditional
      hostname storage
      log syslog informational
      service integrated-vtysh-config
      !
      route-map ALLOW-ALL permit 10
      !
      router bgp 64515
       bgp router-id 10.1.0.7
       no bgp default ipv4-unicast
       neighbor 10.1.0.6 remote-as 64512
       !
       address-family ipv4 unicast
        network 10.200.0.1/32
        neighbor 10.1.0.6 activate
        neighbor 10.1.0.6 route-map ALLOW-ALL in
        neighbor 10.1.0.6 route-map ALLOW-ALL out
       exit-address-family
      !
      line vty
      !
      EOF

      # Set proper permissions
      sudo chown frr:frr /etc/frr/frr.conf
      sudo chmod 640 /etc/frr/frr.conf

      # Start FRR
      echo "=== Starting FRR ==="
      sudo systemctl enable frr
      sudo systemctl restart frr

      echo ""
      echo "=== FRR configured and started ==="
      echo ""

      # Wait a moment for BGP to initialize
      sleep 2

      # Show BGP status
      echo "BGP Summary:"
      sudo vtysh -c 'show bgp summary'
      echo ""

      # Create HTTP server content
      echo "=== Setting up HTTP server ==="
      sudo mkdir -p /var/www/storage
      sudo tee /var/www/storage/index.html > /dev/null <<'EOF'
      <!DOCTYPE html>
      <html>
      <head>
          <title>Storage VM</title>
      </head>
      <body>
          <h1>Storage VM HTTP Server</h1>
          <p>This server is running on the storage VM and is reachable via BGP-advertised IP.</p>
          <p>Server IP: 10.200.0.1</p>
          <p>Hostname: storage</p>
      </body>
      </html>
      EOF

      # Create systemd service for HTTP server
      echo "=== Creating HTTP server systemd service ==="
      sudo tee /etc/systemd/system/storage-http.service > /dev/null <<'EOF'
      [Unit]
      Description=Storage VM HTTP Server
      After=network.target frr.service

      [Service]
      Type=simple
      WorkingDirectory=/var/www/storage
      ExecStart=/usr/bin/python3 -m http.server 8080 --bind 10.200.0.1
      Restart=always
      User=fedora

      [Install]
      WantedBy=multi-user.target
      EOF

      # Start HTTP server
      sudo systemctl daemon-reload
      sudo systemctl enable storage-http.service
      sudo systemctl restart storage-http.service

      echo ""
      echo "=== HTTP server started on 10.200.0.1:8080 ==="
      echo ""
      echo "=== Setup complete! ==="
      echo ""
      echo "To verify BGP peering:"
      echo "  sudo vtysh -c 'show bgp summary'"
      echo ""
      echo "To verify advertised routes:"
      echo "  sudo vtysh -c 'show bgp ipv4 unicast'"
      echo ""
      echo "To check HTTP server status:"
      echo "  sudo systemctl status storage-http.service"
      echo ""
      echo "To test HTTP server locally:"
      echo "  curl http://10.200.0.1:8080"
      echo ""
